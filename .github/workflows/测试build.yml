name: æµ‹è¯• Mesa (aarch64, Auto Update + Detailed Log)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - 'refs/tags/**'
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 6 ç‚¹ï¼ˆUTC+8 â†’ UTC-8 = 22 ç‚¹ï¼‰
    - cron: "0 22 * * *"

permissions:
  contents: write
  actions: write

jobs:
  check-updates:
    runs-on: ubuntu-24.04-arm
    outputs:
      new_commit: ${{ steps.check.outputs.new_commit }}
      latest_hash: ${{ steps.check.outputs.latest_hash }}
    steps:
      - name: æ£€æŸ¥ Mesa ä¸Šæ¸¸æ›´æ–°
        id: check
        run: |
          echo "ğŸ” æ£€æŸ¥ Mesa ä¸Šæ¸¸æäº¤..."

          # è·å–ä½ ä»“åº“çš„æœ€æ–°æäº¤
          LATEST_HASH=$(git ls-remote https://github.com/DvaMishkiLapa/mesa-turnip-kgsl-build.git HEAD | awk '{print $1}')
          echo "æœ€æ–°ä¸Šæ¸¸æäº¤: $LATEST_HASH"

          STATE_FILE=".mesa_latest_commit"
          if [ -f "$STATE_FILE" ]; then
            LAST_HASH=$(cat $STATE_FILE)
          else
            LAST_HASH=""
          fi
          echo "ä¸Šæ¬¡æ„å»º: $LAST_HASH"

          if [ "$LATEST_HASH" != "$LAST_HASH" ]; then
            echo "âœ… æ£€æµ‹åˆ°æ–°æäº¤ï¼Œè§¦å‘æ„å»º"
            echo "new_commit=true" >> $GITHUB_OUTPUT
            echo "latest_hash=$LATEST_HASH" >> $GITHUB_OUTPUT
          else
            echo "â æ²¡æœ‰æ–°æäº¤ï¼Œè·³è¿‡æ„å»º"
            echo "new_commit=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check-updates
    if: ${{ needs.check-updates.outputs.new_commit == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}
    runs-on: ubuntu-24.04-arm

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: æ˜¾ç¤ºæ„å»ºç¯å¢ƒä¿¡æ¯
        run: |
          echo "ğŸ—ï¸ æ„å»ºç¯å¢ƒ:"
          lsb_release -a || true
          uname -a
          echo "CPU ä¿¡æ¯:"
          lscpu | grep -E 'Model name|Architecture|CPU MHz|Core'
          echo "å†…å­˜ä½¿ç”¨æƒ…å†µ:"
          free -h
          echo "ç£ç›˜ç©ºé—´:"
          df -h

      - name: å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ“¦ å®‰è£… Mesa æ„å»ºä¾èµ–..."
          sudo sed -i "s/^Types: deb$/Types: deb deb-src/" /etc/apt/sources.d/ubuntu.sources 2>/dev/null || true
          sudo sed -i "s/^Types: deb$/Types: deb deb-src/" /etc/apt/sources.list.d/ubuntu.sources 2>/dev/null || true
          sudo apt update
          sudo apt install -y glslang-tools libxrandr-dev libxxf86vm-dev libxcb-shm0-dev libxcb-glx0-dev \
              libxext-dev llvm-19 libx11-dev libx11-xcb-dev libxcb1-dev libxcb-dri3-dev libxcb-present-dev \
              libxcb-randr0-dev libxcb-sync-dev libxcb-xfixes0-dev libxshmfence-dev libdrm-dev \
              libgbm-dev libegl1-mesa-dev libexpat1-dev libwayland-dev python3-pip
          pip3 install --user meson ninja mako
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: å…‹éš† Mesa ä»“åº“
        run: |
          echo "ğŸ“¥ å…‹éš† Mesa Turnip KGSL ä»“åº“..."
          git clone https://github.com/DvaMishkiLapa/mesa-turnip-kgsl-build.git
          cd mesa-turnip-kgsl-build
          git checkout main || git checkout master || true
          git pull || true

          echo "ğŸ”§ è‡ªå®šä¹‰å“ç‰Œ: Turnip â†’ Qualcomm Snapdragon"
          # these sed's may fail if files are different; ignore errors
          sed -i 's/Turnip Adreno (TM) %s%s/Qualcomm Snapdragon Adreno (TM) %s%s/' src/freedreno/vulkan/tu_device.cc || true
          sed -i 's/\"turnip Mesa driver\"/\"Qualcomm Snapdragon Driver\"/' src/freedreno/vulkan/tu_device.cc || true
          sed -i 's/\"Mesa \" PACKAGE_VERSION MESA_GIT_SHA1/\"Qualcomm Snapdragon \" PACKAGE_VERSION MESA_GIT_SHA1/' src/freedreno/vulkan/tu_device.cc || true

          echo "ğŸ§¾ æœ€æ–°æäº¤:"
          git log -1 --oneline --decorate || true

      - name: å†™å…¥å¹¶åº”ç”¨è¡¥ä¸ï¼ˆx11_dri3 ä¿®å¤ï¼‰
        run: |
          set -e
          echo "ğŸ§© åˆ›å»º patches ç›®å½•å¹¶å†™å…¥è¡¥ä¸æ–‡ä»¶..."
          mkdir -p patches
          cat > patches/x11_dri3_fix.patch <<'PATCHEOF'
*** Begin Patch
*** Update File: path/to/affected/file.c
@@
-      xshmfence_await(chain->images[*image_index].shm_fence);
-#endif
-
-    return result;
- }
-@@ -2142,15 +2121,24 @@ x11_image_init(VkDevice device_h, struct x11_swapchain *chain,
-      if (fd == -1)
-         return VK_ERROR_OUT_OF_HOST_MEMORY;
-
-      cookie =
-         xcb_dri3_pixmap_from_buffer_checked(chain->conn,
-                                             image->pixmap,
-                                             chain->window,
-                                             image->base.sizes[0],
-                                             pCreateInfo->imageExtent.width,
-                                             pCreateInfo->imageExtent.height,
-                                             image->base.row_pitches[0],
-                                             chain->depth, bpp, fd);
-+      cookie = xcb_dri3_pixmap_from_buffers_checked(chain->conn,
-+                                                    image->pixmap,
-+                                                    chain->window,
-+                                                    image->base.num_planes,
-+                                                    pCreateInfo->imageExtent.width,
-+                                                    pCreateInfo->imageExtent.height,
-+                                                    image->base.row_pitches[0],
-+                                                    image->base.offsets[0],
-+                                                    0,
-+                                                    0,
-+                                                    0,
-+                                                    0,
-+                                                    0,
-+                                                    0,
-+                                                    chain->depth,
-+                                                    bpp,
-+                                                    1274,
-+                                                    &fd);
-     }
-
-    error = xcb_request_check(chain->conn, cookie);
-@@ -2180,6 +2168,9 @@ x11_image_init(VkDevice device_h, struct x11_swapchain *chain,
-    }
- #endif
-
-+   image->sync_fence = 0;
-+   return VK_SUCCESS;
-+
- out_fence:
-    fence_fd = xshmfence_alloc_shm();
-    if (fence_fd < 0)
-@@ -2222,12 +2213,6 @@ x11_image_finish(struct x11_swapchain *chain,
- {
-    xcb_void_cookie_t cookie;
-    if (!chain->base.wsi->sw || chain->has_mit_shm) {
--#ifdef HAVE_X11_DRM
--      cookie = xcb_sync_destroy_fence(chain->conn, image->sync_fence);
--      xcb_discard_reply(chain->conn, cookie.sequence);
--      xshmfence_unmap_shm(image->shm_fence);
--#endif
-
-       cookie = xcb_free_pixmap(chain->conn, image->pixmap);
-       xcb_discard_reply(chain->conn, cookie.sequence);
- #ifdef HAVE_X11_DRM
*** End Patch
PATCHEOF

          echo "ğŸ§© è¯•å›¾åœ¨ä»“åº“å†…åº”ç”¨è¡¥ä¸..."
          # å°è¯•å®šä½ä»“åº“å¹¶åº”ç”¨è¡¥ä¸ï¼›è‹¥è·¯å¾„ä¸åŒè¯·è°ƒæ•´
          if [ -d "mesa-turnip-kgsl-build" ]; then
            cd mesa-turnip-kgsl-build
          fi

          # æ˜¾ç¤º git çŠ¶æ€ï¼Œæ–¹ä¾¿è°ƒè¯•
          git status --porcelain --untracked-files=all || true

          # å°è¯•åº”ç”¨è¡¥ä¸ï¼ˆå¤±è´¥åˆ™è¾“å‡ºæ—¥å¿—å¹¶é€€å‡ºï¼‰
          if git apply --whitespace=fix --verbose ../patches/x11_dri3_fix.patch; then
            echo "âœ… è¡¥ä¸åº”ç”¨æˆåŠŸ"
            git add -A || true
            git commit -m "Apply x11_dri3_fix patch" || echo "no commit (maybe nothing changed)"
          else
            echo "âŒ è¡¥ä¸åº”ç”¨å¤±è´¥ï¼šè¯·æ£€æŸ¥è¡¥ä¸è·¯å¾„æˆ–ä¸Šä¸‹æ–‡æ˜¯å¦åŒ¹é…ä»“åº“æºç "
            echo "è¡¥ä¸æ–‡ä»¶å†…å®¹é¢„è§ˆï¼š"
            sed -n '1,200p' ../patches/x11_dri3_fix.patch || true
            exit 1
          fi

      - name: æ„å»º Mesa
        run: |
          cd mesa-turnip-kgsl-build
          BUILD_START=$(date +%s)
          sudo mkdir -p /data/data/com.termux/files/usr/glibc
          sudo chmod 777 -R /data

          echo "âš™ï¸ é…ç½® Meson..."
          mkdir -p builddir
          meson setup builddir \
            --libdir=lib \
            -Dprefix=/data/data/com.termux/files/usr/glibc \
            -Dbuildtype=release \
            -Doptimization=3 \
            -Db_lto=true \
            -Dplatforms=x11 \
            -Degl-native-platform=x11 \
            -Dglx=dri \
            -Dglx-direct=true \
            -Dopengl=true \
            -Dgles1=enabled \
            -Dgles2=enabled \
            -Dglvnd=enabled \
            -Degl=enabled \
            -Dllvm=enabled \
            -Dshared-llvm=enabled \
            -Dshader-cache=enabled \
            -Dxlib-lease=enabled \
            -Dvulkan-beta=true \
            -Dlibunwind=disabled \
            -Dvalgrind=disabled \
            -Dmicrosoft-clc=disabled \
            -Dgallium-rusticl=false \
            -Dgallium-extra-hud=true \
            -Dgallium-drivers=zink,freedreno,llvmpipe,softpipe \
            -Dgallium-rusticl-enable-drivers=freedreno \
            -Dshader-cache-default=true \
            -Dvulkan-drivers=freedreno,swrast,virtio \
            -Dfreedreno-kmds=msm,kgsl \
            -Dvideo-codecs=all \
            -Dmediafoundation-codecs=all \
            -Dgbm=enabled \
            -Dtools=drm-shim,freedreno

          echo "ğŸ§± å¼€å§‹ç¼–è¯‘..."
          ninja -C builddir -j$(nproc)
          ninja -C builddir install

          BUILD_END=$(date +%s)
          echo "ğŸ•’ æ„å»ºè€—æ—¶: $((BUILD_END - BUILD_START)) ç§’"

          VERSION=$(cat VERSION)
          GIT_HASH=$(git rev-parse --short HEAD)
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "GIT_HASH=${GIT_HASH}" >> $GITHUB_ENV

      - name: æ‰“åŒ…æ„å»ºäº§ç‰©
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
          cd mesa-turnip-kgsl-build
          PACK_START=$(date +%s)

          TAR_NAME="termux-glibc-mesa-${VERSION}-aarch64.tar.gz"
          FULL_TAR="glibc-mesa-${VERSION}-aarch64.tar.gz"

          tar -czvf "../${TAR_NAME}" -C builddir/src/freedreno/vulkan libvulkan_freedreno.so
          tar -czvf "../${FULL_TAR}" -C /data/data/com.termux/files/usr glibc

          cd ..
          sha256sum "${TAR_NAME}" > "${TAR_NAME}.sha256"
          sha256sum "${FULL_TAR}" > "${FULL_TAR}.sha256"

          echo "ğŸ“‚ è¾“å‡ºæ–‡ä»¶:"
          du -h ${TAR_NAME} ${FULL_TAR}

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: mesa-artifacts-${{ env.VERSION }}-aarch64
          path: |
            ${{ env.TAR_NAME }}
            ${{ env.FULL_TAR }}
            ${{ env.TAR_NAME }}.sha256
            ${{ env.FULL_TAR }}.sha256

      - name: ä¿å­˜æœ€æ–°æäº¤è®°å½•
        if: ${{ needs.check-updates.outputs.latest_hash != '' }}
        run: |
          echo "${{ needs.check-updates.outputs.latest_hash }}" > .mesa_latest_commit
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .mesa_latest_commit || true
          git commit -m "Update Mesa commit record to ${{ needs.check-updates.outputs.latest_hash }}" || true
          git push || true

      - name: è¾“å‡ºæ€»ç»“ä¿¡æ¯
        run: |
          echo "âœ… Mesa æ„å»ºä¸æ‰“åŒ…å®Œæˆ"
          echo "ğŸ”– Mesa ç‰ˆæœ¬: ${{ env.VERSION }}"
          echo "ğŸ’¾ æäº¤å“ˆå¸Œ: ${{ env.GIT_HASH }}"
          echo "ğŸ“… æ„å»ºæ—¶é—´: $(date)"
          uname -a
